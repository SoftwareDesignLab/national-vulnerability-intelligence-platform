app.controller('MainController', [ '$scope', '$http', '$routeParams', '$cookieStore', function($scope, $http, $routeParams, $cookieStore) {
     
    $http.defaults.headers.post["Content-Type"] = "application/x-www-form-urlencoded; charset=utf-8";
    
    $scope.init = function () {
		$scope.toggleLoadingScreen(true, "nvip-daily-graph-box");
    	$scope.countGraphs();
    };
    
    /** Controller Functions **/
    $scope.countGraphs = function () {
    	
    	$http({
            url : 'mainServlet',
            method : "GET",  
            params : {countGraphs: "all"}       
        }).then(function(response) {
            $scope.countGraphs = {};
            
            angular.forEach(response.data.map.mainPageCounts.map, function(value, key) {
            	$scope.countGraphs[key] = value;
            });
            
			$scope.loadGraphs();            
			$scope.toggleLoadingScreen(false, "nvip-daily-graph-box");
        }, function(response) {
        	if (response.status == 401){
				alert(response.data);
            	window.location.assign(window.location.href+"login");
            }
           
            console.log("Failure -> " + response.data);
            //$scope.countGraphs = response.data.map;
        });
	};
    
	$scope.toggleLoadingScreen = function(loading, className){
		if(className == "nvip-daily-graph-box"){
    		var graphBox = document.getElementsByClassName("nvip-daily-graph-box")[0];
			var loadingScreen = graphBox.getElementsByClassName("nvip-loading-screen")[0];
			var circleGraphs = graphBox.getElementsByClassName("nvip-circle-graph");
    		if(loading){
    			loadingScreen.style.display = 'block';
				angular.forEach(circleGraphs, function(circleGraph, index) {
					circleGraph.style.display = 'none';
				});
    		} 
    		else {
    			loadingScreen.style.display = 'none';
				angular.forEach(circleGraphs, function(circleGraph, index) {
					circleGraph.style.display = 'block';
				});
    		}
    	}
    		
    }

	$scope.loadGraphs = function() {
	
		google.charts.load('47', {'packages':['bar', 'corechart', 'line']});
    	google.charts.setOnLoadCallback(setGraphs);
	}
	
	function setGraphs() {
		
			if (!(window.location.href).includes('/login')) {
				return
			}
		
		
			
			var newDates = [];
			var dates = $scope.countGraphs.run_date_times.split(";");	
			for (var i = 0; i < 6 && i < dates.length; i++) {
				var mysqlDate = new Date(dates[i]);
				var date = ((mysqlDate.getMonth()+1)+'/'+mysqlDate.getDate()+'/'+(mysqlDate.getFullYear() - 2000));
				newDates[i] = date;  	
			}
			
			//1rst Graph Init
		      var data1 = new google.visualization.DataTable();
	
			data1.addColumn("string", "");
			data1.addColumn("number", "# of CVEs Added or Updated");
			
	
			var addedCount = $scope.countGraphs.CvesAdded.split(";");
			var updatedCount = $scope.countGraphs.CvesUpdated.split(";");
	
			for (var i =0; i < 6 && i < newDates.length; i++) {
				if (addedCount[i] != null && updatedCount[i] != null) {
					data1.addRow([newDates[i], (parseInt(addedCount[i]) + parseInt(updatedCount[i]))]);
				}
			}
			  
	
			//2nd Graph Init
			  var data2 = new google.visualization.DataTable();
		  
			  data2.addColumn("string", ""); //run date time
			  data2.addColumn("number", "CVEs Not In NVD");
				
	          var dates = $scope.countGraphs.run_date_times.split(";");		  
	          var nNVD = $scope.countGraphs.not_in_nvd_count.split(";");
	
			  for (var i = 0; i < 6 && i < newDates.length; i++) {
			  	if (nNVD[i] != null) {
				  	data2.addRow([newDates[i], parseInt(nNVD[i])]);
				}
			  }
	
			//3rd Graph Init
			var data3 = new google.visualization.DataTable();
		  
			  data3.addColumn("string", ""); //run date time
			  data3.addColumn("number", "Avg. Time Gap From NVD");
		  
	          var avgNVD = $scope.countGraphs.avgTimeGapNvd.split(";");
	
			  for (var i = 0; i < 6 && i < newDates.length; i++) {
				if (avgNVD[i] != null) {
				  	data3.addRow([newDates[i], parseInt(avgNVD[i])]);
				}
			  }
			
			
			
			var baseWidth = document.getElementById("graph").clientWidth;
			var generalWidth = baseWidth - (.1*(baseWidth));
			
			
			//1rst graph style
		      var options1 = {
		        legend: { position: 'none' },
		        bar: { groupWidth: "60%" },
				height: 167,
				width: generalWidth,
				backgroundColor: {
					fill: '#F5F5F5',	
				},
				chartArea: {
					backgroundColor: '#F5F5F5',
				},
				vAxis: {
					gridlines: {
						color: 'black'
					},
					baselineColor:'black',
					textStyle: {
						color: 'black'
					}
				},
				hAxis: {
					baselineColor: 'black',
					textStyle: {
						color: 'black'
					}
				},
				colors: ['#d9895d'],
				series: {
					0: { axis: '# of CVEs Added'},
				}
			};
			
			//2nd graph style
		      var options2 = {
					legend: { position: 'none' },
					backgroundColor: {
						fill: '#F5F5F5',	
					},
					chartArea: {
						backgroundColor: '#F5F5F5',
					},
					height: 167,
					width: generalWidth,
					vAxis: {
						gridlines: {
							color: 'black'
						},
						baselineColor:'black',
						textStyle: {
							color: 'black'
						}
					},
					hAxis: {
						textStyle: {
							color: 'black'
						},
						textPosition: 'none',
						baselineColor: 'black',
					},
					colors: ['#d9895d']
			  };
	
			//3rd graph style
		      var options3 = {
					legend: { position: 'none' },
					backgroundColor: {
						fill: '#F5F5F5',	
					},
					chartArea: {
						backgroundColor: '#F5F5F5',
					},
					height: 167,
					width: generalWidth,
					vAxis: {
						gridlines: {
							color: 'black'
						},
						baselineColor:'black',
						textStyle: {
							color: 'black'
						}
					},
					hAxis: {
						textStyle: {
							color: 'black'
						},
						textPosition: 'none',
						baselineColor: 'black',
					},
				  axisFontSixe: 0,
				  colors: ['#d9895d']
			  };
		      
			  var chart1 = new google.charts.Bar(document.getElementById('chart_values1'));
	     
			  var chart2 = new google.charts.Bar(document.getElementById('chart_values2'));
	
			  var chart3 = new google.charts.Bar(document.getElementById('chart_values3'));
	
			  chart1.draw(data1, google.charts.Bar.convertOptions(options1));
	
			  chart2.draw(data2, google.charts.Bar.convertOptions(options2));
	
			  chart3.draw(data3, google.charts.Bar.convertOptions(options3));
	
			  window.onresize = setGraphs;
	 
		}
	
} ]);