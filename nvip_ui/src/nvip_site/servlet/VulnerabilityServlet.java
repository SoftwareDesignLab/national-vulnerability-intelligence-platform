package nvip_site.servlet;

import java.io.IOException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.json.JSONArray;
import org.json.JSONObject;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;

import nvip_site.dao.LocalDateSerializer;
import nvip_site.dao.VulnerabilityDAO;
import nvip_site.model.Vulnerability;

@WebServlet("/vulnerabilityServlet")
public class VulnerabilityServlet extends HttpServlet {
	private static final Logger logger = LogManager.getLogger(VulnerabilityServlet.class);

	private static final long serialVersionUID = 1L;
	private JsonArray toJsonArray(Gson gson, Collection c, Class clazz) {
		JsonElement element = gson.toJsonTree(c, clazz);
		if (!element.isJsonArray()) {
			return null;
		}

		return element.getAsJsonArray();
	}

	@Override
	public void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException {
		handleRequest(req, resp);
	}

	public void handleRequest(HttpServletRequest req, HttpServletResponse resp) {
		int vulnId = req.getParameter("vulnId") == null ? 0 : Integer.parseInt(req.getParameter("vulnId"));
		boolean daily = req.getParameter("daily") == null ? false : Boolean.parseBoolean(req.getParameter("daily"));
		String match = req.getParameter("match") == null ? "" : req.getParameter("match");

		JSONArray arrayObj = null;
		JsonObject dailyVulnsJson = new JsonObject();
		JsonObject allVunsJson = new JsonObject();

		GsonBuilder gsonBuilder = new GsonBuilder();
		gsonBuilder.registerTypeAdapter(LocalDate.class, new LocalDateSerializer());
		Gson gson = gsonBuilder.setPrettyPrinting().create();

		try {
			if (vulnId != 0) {
				Vulnerability vuln = VulnerabilityDAO.getVulnerability(vulnId);
				String jObj = gson.toJson(vuln);
				
				resp.setContentType("text/html");
				resp.setCharacterEncoding("UTF-8");
				resp.getWriter().write(jObj);
			} else if (daily) {
				int dateRange = req.getParameter("dateRange") == null ? 0 : Integer.parseInt(req.getParameter("dateRange"));
				Map<LocalDate, List<Vulnerability>> dailyVulns = VulnerabilityDAO.getDailyVulnerabilities(dateRange);

				removeLowQualityCves(dailyVulns);

				int i = 0;
				for (LocalDate date : dailyVulns.keySet().stream().sorted((e1, e2) -> e2.compareTo(e1)).collect(Collectors.toList())) {
					dailyVulnsJson = new JsonObject();

					dailyVulnsJson.add("date", gson.toJsonTree(date, LocalDate.class));
					dailyVulnsJson.add("list", toJsonArray(gson, dailyVulns.get(date), List.class));

					allVunsJson.add(i + "", gson.toJsonTree(dailyVulnsJson));
					i++;
				}

				String testObj = gson.toJson(allVunsJson);
				resp.setContentType("text/html");
				resp.setCharacterEncoding("UTF-8");
				resp.getWriter().write(testObj);
			} else if (match != "") {
				logger.debug("Match hit: {}", match);
				List vulns = VulnerabilityDAO.getVulnerabilityByMatch(match);

				arrayObj = null;
				String jObj = new Gson().toJson(arrayObj);

				resp.setContentType("text/html");
				resp.setCharacterEncoding("UTF-8");
				resp.getWriter().write(jObj);
			}

		} catch (IOException ex) {
			logger.error(ex.toString());
		}
	}

	private void removeLowQualityCves(Map<LocalDate, List<Vulnerability>> dailyVulns) {
		String pattern = "\\bCVE-20\\d{2}-\\d{4,5}\\b";

		Pattern p = Pattern.compile(pattern);
		Matcher m;

		int patternLength = 0;

		for (LocalDate date : dailyVulns.keySet()) {
			List<Vulnerability> vulns = dailyVulns.get(date);
			for (int i = 0; i < vulns.size(); i++) {
				m = p.matcher(vulns.get(i).getDescription());
				while (m.find())
					patternLength += m.group().length();

				if (patternLength >= vulns.get(i).getDescription().length() * 0.9) {
					vulns.remove(i);
					i--; // Decrement so on same position in list
				}

				patternLength = 0;
			}
		}
	}
}