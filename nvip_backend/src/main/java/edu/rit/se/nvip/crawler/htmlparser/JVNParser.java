package edu.rit.se.nvip.crawler.htmlparser;

import edu.rit.se.nvip.model.CompositeVulnerability;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.lang.reflect.Array;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

public class JVNParser extends AbstractCveParser {

    public JVNParser(String domainName) { sourceDomainName = domainName; }

    private ArrayList<String> getCVEIdsFromText(String[] text) {
        ArrayList<String> cves = new ArrayList<>();
        for (String str : text)
            if (str.matches(".*?\\bCVE-\\b.*?"))
                cves.add(str);
        return cves;
    }

    @Override
    public List<CompositeVulnerability> parseWebPage(String sSourceURL, String sCVEContentHTML) {

        List<CompositeVulnerability> vulnList = new ArrayList<>();

        Document doc = Jsoup.parse(sCVEContentHTML);

        // get published date and last updated from 'head-bar' component at top
        Element headBar = doc.select("div#head-bar-txt").first();
        String publishedDate = "";
        String lastUpdated = "";
        if (headBar != null) {
            String headBarText = headBar.text();
            String[] split = headBarText.split("最終更新日：");
            lastUpdated = split[1].trim().replaceAll("　", "");
            String[] pubSplit = split[0].split("公開日：");
            // weird spaces found in parsing text, make sure we get rid of those as well
            publishedDate = pubSplit[1].trim().replaceAll("　", "");
        }

        // headers are images with informative alt text
        // get potential cves in 'related document', 'detailed information' or
        // 'potential impact' sections

        // the table at the bottom of the page
        Element relatedDocument = doc.select("img[alt*=関連文書]").first();
        // sections 2-4 on the page - right below 'overview' and 'affected system'
        Element detailedInformation = doc.select("img[alt*=詳細情報]").first();
        Element potentialImpact = doc.select("img[alt*=想定される影響]").first();

        Element boxParent = relatedDocument.parent().parent();
        Elements potentialCves = boxParent.children().select("a:contains(CVE-)");
        List<String> cveTexts = potentialCves.eachText();

        String detailedInformationText = detailedInformation.parent().parent().text();
        String potentialImpactText = potentialImpact.parent().parent().text();

        ArrayList<String> detailedCVEs = getCVEIdsFromText(detailedInformationText.split(" "));
        ArrayList<String> impactCVEs = getCVEIdsFromText(potentialImpactText.split(" "));

        // remove duplicates
        ArrayList<String> combined = new ArrayList<>(cveTexts);
        combined.addAll(detailedCVEs);
        combined.addAll(impactCVEs);
        HashSet<String> cveIds = new HashSet<>(combined);

        // if no cves found we can return
        if (cveIds.isEmpty()) return vulnList;

        // otherwise continue with getting description from 'detailed information' and
        // 'potential impact' sections
        for (String cve : cveIds)
            vulnList.add(new CompositeVulnerability(
               0, sSourceURL, cve, null, publishedDate, lastUpdated, detailedInformationText + potentialImpactText, sourceDomainName
            ));

        return vulnList;
    }
}
